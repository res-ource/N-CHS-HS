<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Comparison & Interactive Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Dark Theme & Typography */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
        }
        
        /* --- Lesson-Specific Styles --- */
        .function-table {
            border-collapse: separate;
            border-spacing: 0;
            border: 2px solid #10b981; /* Accent border */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .function-table th, .function-table td {
            padding: 0.5rem;
            border: 1px solid #374151;
            text-align: center;
        }
        .function-table th {
            background-color: #374151;
            color: #d1d5db;
        }
        .function-table td {
            background-color: #111827;
            color: #f3f4f6;
        }
        .quiz-option {
             transition: background-color 0.15s, border-color 0.15s, box-shadow 0.15s;
        }
        .quiz-option:hover {
            background-color: #4b5563;
        }
        .quiz-option.selected {
            border: 3px solid #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            background-color: #10b981;
            color: white;
        }
        .quiz-option.correct {
            border: 3px solid #10b981;
            background-color: #059669;
            color: white;
        }
        .quiz-option.incorrect {
            border: 3px solid #ef4444;
            background-color: #b91c1c;
            color: white;
        }
        #function-canvas {
            background-color: #111827;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* --- Builder-Specific Styles --- */
        .input-table input {
            width: 100%;
            background-color: #374151;
            color: #f3f4f6;
            text-align: center;
            border: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
            outline: none;
            transition: border-color 0.15s;
        }
        .input-table input:focus {
             border: 2px solid #f59e0b;
        }
        #plot-canvas {
            background-color: #111827;
            border-radius: 0.5rem;
            border: 2px solid #10b981;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            width: 100%;
            height: 350px;
        }
    </style>
</head>
<body>

<div class="max-w-4xl mx-auto p-4 md:p-8">
    <h1 class="text-4xl font-extrabold text-white mb-6 text-center">
        Function Explorer & Builder
    </h1>

    <!-- Lesson Card - This card houses both the lesson flow and the builder mode -->
    <div id="lesson-card" class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10 transition-all duration-500 flex flex-col">
        
        <!-- Content Area (for lesson steps or builder tool) -->
        <div id="card-content" class="text-white">
            <!-- Content will be injected here -->
        </div>

        <!-- Feedback and Navigation -->
        <div class="mt-8 pt-6 border-t border-gray-700">
            <p id="feedback-message" class="text-center font-semibold mb-4 hidden"></p>
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-400" id="step-indicator">Step 1 / 22</p>
                <button id="next-button" class="px-6 py-3 bg-teal-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-teal-400 transition duration-150" disabled>
                    Start Lesson
                </button>
            </div>
        </div>
    </div>

    <!-- The actual canvas elements, kept outside the card for re-appending -->
    <canvas id="function-canvas" class="w-full h-52 mt-6 hidden"></canvas>
</div>


<!-- Builder UI elements (Hidden by default, shown inside the card on the Builder step) -->
<div id="builder-ui-template" class="hidden">
    <div class="flex flex-col md:flex-row gap-6 mt-6">
        <!-- Table Builder (Left Side) -->
        <div class="md:w-1/3">
            <h2 class="text-xl font-semibold mb-3 text-yellow-400">1. Calculate & Enter Values</h2>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="mb-4">
                    <label for="function-select" class="text-sm font-medium text-gray-200 block mb-2">Select Function:</label>
                    <select id="function-select" class="bg-gray-800 text-white p-2 rounded-lg w-full">
                        <!-- Options generated by JS -->
                    </select>
                </div>
                <p id="current-equation" class="text-lg font-bold text-teal-300 text-center mb-4">Equation: y = 3x - 2</p>
                <table id="builder-table" class="function-table input-table">
                    <!-- Table content generated by JS -->
                </table>
                <button id="plot-button" class="mt-4 w-full px-4 py-2 bg-orange-500 text-gray-900 font-bold rounded-lg hover:bg-orange-400 transition duration-150">
                    Plot Points
                </button>
            </div>
            <p class="text-sm text-gray-400 mt-2 text-center">Click 'Plot Points' to check your table and see your points appear below.</p>
        </div>

        <!-- Plotting Canvas (Right Side) -->
        <div class="md:w-2/3">
            <h2 class="text-xl font-semibold mb-3 text-yellow-400">2. Visualize the Points</h2>
            <!-- The canvas will be appended here -->
            <div id="plot-canvas-container" class="h-full">
                <canvas id="plot-canvas"></canvas>
            </div>
            <p class="text-sm text-gray-400 mt-2">Red dots are incorrect; green dots match the function curve (dashed line).</p>
        </div>
    </div>
</div>

<script>
    const lessonCard = document.getElementById('lesson-card');
    const cardContent = document.getElementById('card-content');
    const nextButton = document.getElementById('next-button');
    const feedbackMessage = document.getElementById('feedback-message');
    const stepIndicator = document.getElementById('step-indicator');
    
    // Lesson Canvas elements
    const lessonCanvas = document.getElementById('function-canvas');
    const lessonCtx = lessonCanvas.getContext('2d');

    // Builder elements
    const builderUITemplate = document.getElementById('builder-ui-template');
    let builderUIInstance = null;
    let builderSection = null; // Reference to the actual builder div
    let functionSelect, currentEquation, builderTable, plotButton, plotCanvas, plotCtx;

    let currentStep = 0;
    let score = 0;
    let totalQuestions = 0;
    let selectedAnswer = null;
    let currentQuizAnswer = null;
    let isBuilderMode = false;

    // --- Data for the Lesson Steps (22 Steps Total) ---
    const lessonData = [
        // --- PHASE 1: INTRODUCTION ---
        {
            type: 'text',
            title: 'Welcome to the Function Explorer!',
            content: 'This lesson will help you visualize the three main function types—<b>Linear, Quadratic, and Exponential</b>—by comparing their tables and their graphs. You must complete each card before moving to the next. Click "Start Lesson" to begin!',
            buttonText: 'Next',
        },
        // --- PHASE 2: LINEAR FUNCTIONS (Steps 2-7) ---
        {
            type: 'content',
            title: '1. Linear Functions: Constant Change',
            explanation: 'Linear functions have a <b>constant rate of change</b> (the slope). In a table, the difference between consecutive output values (f(x) or y) is always the same number (the <b>First Difference</b>). The graph is a straight line.',
            tableHtml: `
                <table class="function-table w-48 mt-4">
                    <thead><tr><th>x</th><th>f(x)</th><th>Difference</th></tr></thead>
                    <tbody>
                        <tr><td>-2</td><td>10</td><td rowspan="2" class="text-teal-400 font-bold">-4</td></tr>
                        <tr><td>-1</td><td>6</td></tr>
                        <tr><td>0</td><td>2</td><td rowspan="2" class="text-teal-400 font-bold">-4</td></tr>
                        <tr><td>1</td><td>-2</td></tr>
                        <tr><td>2</td><td>-6</td><td rowspan="2" class="text-teal-400 font-bold">-4</td></tr>
                        <tr><td>3</td><td>-10</td></tr>
                    </tbody>
                </table>
            `,
            visualType: 'linear',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Identify the Linear Table',
            question: 'Which table has a constant <b>First Difference</b>?',
            options: [
                {
                    text: 'A',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>0</td><td>1</td></tr><tr><td>1</td><td>4</td></tr><tr><td>2</td><td>16</td></tr><tr><td>3</td><td>64</td></tr></tbody>', // Exponential
                    isCorrect: false
                },
                {
                    text: 'B',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>-1</td><td>7</td></tr><tr><td>0</td><td>5</td></tr><tr><td>1</td><td>3</td></tr><tr><td>2</td><td>1</td></tr></tbody>', // Linear: -2 difference
                    isCorrect: true
                },
                {
                    text: 'C',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>-2</td><td>8</td></tr><tr><td>-1</td><td>3</td></tr><tr><td>0</td><td>0</td></tr><tr><td>1</td><td>-1</td></tr></tbody>', // Quadratic
                    isCorrect: false
                }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'quiz',
            title: 'Quiz: Linear Function Evaluation',
            question: 'If a linear function is given by f(x) = 11 - 4x, what is the value of f(5)?',
            options: [
                { text: '-9', isCorrect: true }, // 11 - 4(5) = 11 - 20 = -9
                { text: '31', isCorrect: false },
                { text: '1', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'quiz',
            title: 'Quiz: Linear Table Completion',
            question: 'Using the rule f(x) = 5x + 8, what is the output f(x) when the input is x = -3?',
            options: [
                { text: '-7', isCorrect: true }, // 5(-3) + 8 = -15 + 8 = -7
                { text: '23', isCorrect: false },
                { text: '1', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'content',
            title: 'Linear Graph Characteristics',
            explanation: 'The graph of a linear function is always a straight line. The rate of change (slope) dictates the line\'s steepness and direction. A positive slope goes up to the right; a negative slope goes down to the right.',
            visualType: 'linear',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Linear Graph ID',
            question: 'Which statement accurately describes the graph of f(x) = 6x - 10?',
            options: [
                { text: 'A straight line going down to the right.', isCorrect: false },
                { text: 'A straight line going up to the right.', isCorrect: true },
                { text: 'A parabolic curve.', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        // --- PHASE 3: QUADRATIC FUNCTIONS (Steps 8-13) ---
        {
            type: 'content',
            title: '2. Quadratic Functions: The Parabola',
            explanation: 'Quadratic functions (f(x) = ax² + bx + c) have a constantly changing rate. The key is the **Second Difference**: the difference between the first differences is constant. The graph is always a U-shaped curve called a <b>parabola</b>.',
            tableHtml: `
                <table class="function-table w-64 mt-4">
                    <thead><tr><th>x</th><th>f(x)</th><th>1st Diff</th><th>2nd Diff</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>5</td><td rowspan="2" class="font-bold">-2</td><td rowspan="3" class="font-bold text-yellow-400">+4</td></tr>
                        <tr><td>2</td><td>3</td></tr>
                        <tr><td>3</td><td>5</td><td rowspan="2" class="font-bold">+2</td></tr>
                        <tr><td>4</td><td>11</td><td rowspan="3" class="font-bold text-yellow-400">+4</td></tr>
                        <tr><td>5</td><td>21</td><td rowspan="2" class="font-bold">+6</td></tr>
                        <tr><td>6</td><td>35</td></tr>
                    </tbody>
                </table>
            `,
            visualType: 'quadratic',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Identify the Quadratic Table',
            question: 'Which table shows a constant <b>Second Difference</b>?',
            options: [
                {
                    text: 'A',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>1</td><td>-3</td></tr><tr><td>2</td><td>-1</td></tr><tr><td>3</td><td>1</td></tr><tr><td>4</td><td>3</td></tr></tbody>', // Linear
                    isCorrect: false
                },
                {
                    text: 'B',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>-1</td><td>0.5</td></tr><tr><td>0</td><td>1</td></tr><tr><td>1</td><td>2</td></tr><tr><td>2</td><td>4</td></tr></tbody>', // Exponential
                    isCorrect: false
                },
                {
                    text: 'C',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>-2</td><td>10</td></tr><tr><td>-1</td><td>4</td></tr><tr><td>0</td><td>0</td></tr><tr><td>1</td><td>-2</td></tr></tbody>', // 1st diff: -6, -4, -2. 2nd diff: +2, +2.
                    isCorrect: true
                }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'quiz',
            title: 'Quiz: Quadratic Function Evaluation',
            question: 'If f(x) = 2x² + 3x - 1, what is the value of f(2)?',
            options: [
                { text: '9', isCorrect: false },
                { text: '13', isCorrect: true }, // 2(2)^2 + 3(2) - 1 = 8 + 6 - 1 = 13
                { text: '0', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'quiz',
            title: 'Quiz: Quadratic Table Completion',
            question: 'Using the rule f(x) = x² + 7, what is the output f(x) when the input is x = -4?',
            options: [
                { text: '16', isCorrect: false },
                { text: '23', isCorrect: true }, // (-4)^2 + 7 = 16 + 7 = 23
                { text: '-9', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'content',
            title: 'Quadratic Graph Characteristics',
            explanation: 'The parabola is defined by its vertex (the maximum or minimum point) and its symmetry. If the leading coefficient (a) is positive, the parabola opens up (smile); if negative, it opens down (frown).',
            visualType: 'quadratic',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Vertex Form & Direction',
            question: 'The graph of f(x) = 5x² - 1 is a parabola that...',
            options: [
                { text: 'Opens upward and has a minimum point.', isCorrect: true },
                { text: 'Opens downward and has a maximum point.', isCorrect: false },
                { text: 'Is a straight line.', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        // --- PHASE 4: EXPONENTIAL FUNCTIONS (Steps 14-17) ---
        {
            type: 'content',
            title: '3. Exponential Functions: Constant Ratio',
            explanation: 'Exponential functions (f(x) = a · bˣ) involve repeated multiplication, leading to rapid growth or decay. The key is the **Constant Ratio**: you multiply by the same number (the base, b) each time x increases by 1.',
            tableHtml: `
                <table class="function-table w-48 mt-4">
                    <thead><tr><th>x</th><th>f(x)</th><th>Ratio</th></tr></thead>
                    <tbody>
                        <tr><td>0</td><td>10</td><td rowspan="2" class="text-red-400 font-bold">x2</td></tr>
                        <tr><td>1</td><td>20</td></tr>
                        <tr><td>2</td><td>40</td><td rowspan="2" class="text-red-400 font-bold">x2</td></tr>
                        <tr><td>3</td><td>80</td></tr>
                        <tr><td>4</td><td>160</td><td rowspan="2" class="text-red-400 font-bold">x2</td></tr>
                        <tr><td>5</td><td>320</td></tr>
                    </tbody>
                </table>
            `,
            visualType: 'exponential',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Identify the Exponential Table',
            question: 'Which table shows a constant <b>Ratio</b>?',
            options: [
                {
                    text: 'A',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>0</td><td>100</td></tr><tr><td>1</td><td>50</td></tr><tr><td>2</td><td>25</td></tr><tr><td>3</td><td>12.5</td></tr></tbody>', // Ratio is 0.5 (Decay)
                    isCorrect: true
                },
                {
                    text: 'B',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>1</td><td>-3</td></tr><tr><td>2</td><td>-1</td></tr><tr><td>3</td><td>1</td></tr><tr><td>4</td><td>3</td></tr></tbody>', // Linear
                    isCorrect: false
                },
                {
                    text: 'C',
                    table: '<thead><tr><th>x</th><th>y</th></tr></thead><tbody><tr><td>-1</td><td>-5</td></tr><tr><td>0</td><td>-8</td></tr><tr><td>1</td><td>-9</td></tr><tr><td>2</td><td>-8</td></tr></tbody>', // Quadratic
                    isCorrect: false
                }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'content',
            title: 'Exponential Graph Characteristics',
            explanation: 'Exponential graphs are distinguished by their rapid, curved growth (or decay) and the presence of a **horizontal asymptote** (a line the graph approaches but never touches).',
            visualType: 'exponential',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Quiz: Exponential Graph ID',
            question: 'The graph of an exponential function is best described as:',
            options: [
                { text: 'A curve that flattens out to a horizontal asymptote on one side.', isCorrect: true },
                { text: 'A symmetric U-shape centered on the y-axis.', isCorrect: false },
                { text: 'A straight line with a constant slope.', isCorrect: false }
            ],
            buttonText: 'Check Answer',
        },
        {
            type: 'quiz',
            title: 'Quiz: Growth Type',
            question: 'A quantity that grows by 15% per year exhibits exponential growth because...',
            options: [
                { text: 'It has a constant First Difference.', isCorrect: false },
                { text: 'It has a constant Second Difference.', isCorrect: false },
                { text: 'It has a constant Ratio (multiplied by 1.15 each year).', isCorrect: true }
            ],
            buttonText: 'Check Answer',
        },
        // --- PHASE 5: COMPARISON & APPLICATION ---
        {
            type: 'content',
            title: 'Ultimate Comparison: Long-Term Growth',
            explanation: 'Observe the three functions graphed together. While linear and quadratic functions have periods where they grow quickly, the **Exponential** function will always eventually exceed them all.',
            visualType: 'comparison',
            buttonText: 'Next',
        },
        {
            type: 'quiz',
            title: 'Application Quiz: Real-World Scenarios',
            question: 'The value of a car that depreciates by 10% every year is best modeled by which function type?',
            options: [
                { text: 'Linear (constant subtraction)', isCorrect: false },
                { text: 'Quadratic (symmetric path)', isCorrect: false },
                { text: 'Exponential (constant ratio/multiplication)', isCorrect: true }
            ],
            buttonText: 'Check Answer',
            isFinal: true
        },
        // --- NEW PHASE: INTERACTIVE BUILDER (Step 21) ---
        {
            type: 'builder',
            title: 'Interactive Challenge: Build & Plot',
            explanation: 'Test your calculation skills! Select a function, fill out the table by hand, and click "Check My Work". We will instantly plot your points (red/green dots) against the correct function curve (dashed line) for visual feedback.',
            buttonText: 'Check My Work',
        },
        // --- FINAL RESULT (Step 22) ---
        {
            type: 'result',
            title: 'Lesson Complete!',
            content: 'You have finished the Function Comparison lesson. Review your score below to see how well you connected the table patterns to the function types!',
            buttonText: 'Review',
        }
    ];

    // Recalculate total questions dynamically
    totalQuestions = lessonData.filter(step => step.type === 'quiz').length;
    
    // --- Builder Data and Logic ---

    const FUNCTION_DATA = {
        linear: {
            eqText: 'y = 3x - 2',
            equation: (x) => 3 * x - 2,
            xValues: [-2, -1, 0, 1, 2, 3],
            color: '#10b981' // Teal
        },
        quadratic: {
            eqText: 'y = x² + 2x',
            equation: (x) => x * x + 2 * x,
            xValues: [-3, -2, -1, 0, 1, 2],
            color: '#f59e0b' // Yellow/Orange
        },
        exponential: {
            eqText: 'y = 2ˣ',
            equation: (x) => Math.pow(2, x),
            xValues: [-2, -1, 0, 1, 2, 3],
            color: '#ef4444' // Red
        }
    };

    let currentFunctionKey = 'linear';

    // --- Core Lesson Logic (Refactored) ---

    function loadStep() {
        const step = lessonData[currentStep];
        const totalSteps = lessonData.length;
        stepIndicator.textContent = `Step ${currentStep + 1} / ${totalSteps}`;
        selectedAnswer = null;
        feedbackMessage.textContent = '';
        feedbackMessage.classList.add('hidden');
        nextButton.textContent = step.buttonText;
        nextButton.disabled = true;
        isBuilderMode = false;

        // Clean up previous state
        cardContent.innerHTML = '';
        lessonCanvas.style.display = 'none';
        
        // Remove builder UI if it was active
        if (builderSection) {
            builderSection.remove();
            builderSection = null;
        }

        // --- Handle Builder Step ---
        if (step.type === 'builder') {
            isBuilderMode = true;
            // Inject the builder template content into the card
            cardContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-teal-300">${step.title}</h2>
                <p class="text-lg mb-6">${step.explanation}</p>
            `;
            
            // Clone the template and append it to the card content
            builderUIInstance = builderUITemplate.cloneNode(true);
            builderSection = builderUIInstance.firstElementChild; // The inner div
            builderSection.classList.remove('hidden');
            cardContent.appendChild(builderSection);
            
            // Set up element references and event listeners for the builder
            initializeBuilderElements();
            nextButton.textContent = 'Check My Work';
            nextButton.onclick = plotPoints; // Override the next button action
            nextButton.disabled = false;
            return;
        } 
        
        // Reset next button behavior for non-builder steps
        nextButton.onclick = handleNext; 

        // --- Handle Lesson/Quiz/Result Steps ---
        if (step.type === 'text') {
            cardContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-teal-300">${step.title}</h2>
                <p class="text-lg mb-6">${step.content || step.explanation}</p>
            `;
            nextButton.disabled = false;
        }
        else if (step.type === 'content') {
            let combinedContentHtml = `
                <h2 class="text-3xl font-bold mb-4 text-teal-300">${step.title}</h2>
                <p class="text-lg mb-6">${step.explanation}</p>
                <div class="flex flex-col md:flex-row md:gap-6 items-center">
                    <div class="md:w-1/2 flex justify-center mb-6 md:mb-0">
                        ${step.tableHtml ? `<div class="p-4 bg-gray-700 rounded-lg shadow-inner">${step.tableHtml}</div>` : ''}
                    </div>
                    <div id="graph-container" class="md:w-1/2 flex justify-center items-center h-52">
                        <!-- Canvas will be appended here -->
                    </div>
                </div>
            `;
            cardContent.innerHTML = combinedContentHtml;

            const graphContainer = document.getElementById('graph-container');
            if (graphContainer) {
                graphContainer.appendChild(lessonCanvas);
                nextButton.disabled = false;
                setTimeout(() => {
                    setupLessonCanvas();
                    drawLessonGraph(step.visualType);
                }, 50);
            }
        }
        else if (step.type === 'quiz') {
            currentQuizAnswer = step.options.find(opt => opt.isCorrect).text;
            
            let optionsHtml = step.options.map((option, index) => {
                const optionLetter = String.fromCharCode(65 + index);
                const isTableOption = option.table ? true : false;
                const displayContent = isTableOption 
                    ? `<table class="function-table w-full">${option.table}</table>`
                    : option.text;
                
                return `
                    <div data-answer="${option.text}" onclick="selectAnswer('${option.text}')"
                          class="quiz-option p-4 my-2 cursor-pointer rounded-lg border-2 border-gray-600 transition duration-100 ${isTableOption ? 'bg-gray-700' : 'bg-gray-700 hover:bg-gray-600'}">
                        <span class="font-bold text-teal-300">${optionLetter}.</span>
                        ${displayContent}
                    </div>
                `;
            }).join('');

            cardContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-orange-300">${step.title}</h2>
                <p class="text-xl font-semibold mb-6">${step.question}</p>
                <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-3 gap-4">${optionsHtml}</div>
            `;
            
        } else if (step.type === 'result') {
            cardContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-teal-300">${step.title}</h2>
                <p class="text-xl mb-8">You answered <b>${score}</b> out of <b>${totalQuestions}</b> quiz questions correctly!</p>
                <p class="text-lg">Great job connecting the constant differences/ratios in the tables to the unique visual shapes of the graphs.</p>
            `;
            nextButton.textContent = 'Finished';
            nextButton.onclick = () => console.log('Lesson ended.'); 
            nextButton.disabled = false;
        }
    }

    // Expose selectAnswer globally for inline onclick
    window.selectAnswer = (answer) => {
        if (nextButton.textContent !== 'Check Answer' && nextButton.textContent !== 'Check My Work') return;
        
        selectedAnswer = answer;
        nextButton.disabled = false;
        
        document.querySelectorAll('.quiz-option').forEach(el => {
            el.classList.remove('selected');
        });

        document.querySelector(`.quiz-option[data-answer="${answer}"]`).classList.add('selected');
    };

    function handleNext() {
        // If we are checking a quiz, handle the check
        if (nextButton.textContent === 'Check Answer') {
            const step = lessonData[currentStep];

            if (!selectedAnswer) {
                feedbackMessage.textContent = 'Please select an answer.';
                feedbackMessage.classList.remove('hidden');
                feedbackMessage.classList.add('text-red-400');
                return;
            }
            
            // Lock UI and provide feedback
            nextButton.disabled = true;
            document.querySelectorAll('.quiz-option').forEach(el => el.onclick = null);

            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.answer === selectedAnswer) {
                    if (selectedAnswer === currentQuizAnswer) {
                        option.classList.add('correct');
                        feedbackMessage.textContent = 'Correct! That\'s the right pattern.';
                        score++;
                    } else {
                        option.classList.add('incorrect');
                        feedbackMessage.textContent = `Incorrect. The correct answer was ${currentQuizAnswer}.`;
                    }
                }
                // Highlight the correct answer if the student was wrong
                if (option.dataset.answer === currentQuizAnswer && selectedAnswer !== currentQuizAnswer) {
                    option.classList.add('correct');
                }
            });

            feedbackMessage.classList.remove('hidden', 'text-red-400');
            feedbackMessage.classList.add(selectedAnswer === currentQuizAnswer ? 'text-teal-300' : 'text-red-400');
            nextButton.textContent = 'Next';
            nextButton.disabled = false;
            return;
        }

        // If the button says 'Next' or 'Start Lesson', advance to the next step.
        if (nextButton.textContent === 'Next' || nextButton.textContent === 'Start Lesson') {
            currentStep++;
            if (currentStep < lessonData.length) {
                loadStep();
            }
            return;
        }
    }
    
    // --- Lesson Graphing Functions ---

    // Sets up the Canvas size for responsive graphing
    function setupLessonCanvas() {
        const graphContainer = document.getElementById('graph-container');
        if (graphContainer) {
            lessonCanvas.width = graphContainer.clientWidth;
            lessonCanvas.height = 200;
        } else {
            lessonCanvas.width = lessonCard.clientWidth * 0.9;
            lessonCanvas.height = 200;
        }
        
        lessonCtx.strokeStyle = '#d1d5db';
        lessonCtx.lineWidth = 2;
    }

    // Draws the graph visualization on the canvas
    function drawLessonGraph(type) {
        lessonCanvas.style.display = 'block'; 
        lessonCtx.clearRect(0, 0, lessonCanvas.width, lessonCanvas.height);
        
        const W = lessonCanvas.width;
        const H = lessonCanvas.height;
        const centerY = H - 30;

        // Draw Axes
        lessonCtx.beginPath();
        lessonCtx.moveTo(30, 10); lessonCtx.lineTo(30, H - 30); // Y-axis
        lessonCtx.moveTo(10, H - 30); lessonCtx.lineTo(W - 10, H - 30); // X-axis
        lessonCtx.strokeStyle = '#4b5563';
        lessonCtx.stroke();

        let color, pathFunc, yFactor;

        // Define functions for the lesson visuals
        const functions = {
            linear: { color: '#10b981', func: (x) => 0.5 * x + 5, factor: 4, label: 'y = mx + b' },
            quadratic: { color: '#f59e0b', func: (x) => 0.05 * x * x - 2, factor: 4, label: 'y = ax² + bx + c' },
            exponential: { color: '#ef4444', func: (x) => Math.pow(1.1, x) - 10, factor: 1.5, label: 'y = a(b)ˣ' }
        };

        const drawSingleGraph = (graphType) => {
            const f = functions[graphType];
            if (!f) return;

            lessonCtx.strokeStyle = f.color;
            lessonCtx.beginPath();
            let firstPoint = true;
            
            for (let i = 0; i <= W; i += 1) {
                const xDomain = (i / W) * 60 - 10;
                let yVal = f.func(xDomain);
                const yCoord = centerY - yVal * f.factor; 

                if (yCoord < 0 || yCoord > H) {
                    firstPoint = true;
                    continue;
                }

                if (firstPoint) {
                    lessonCtx.moveTo(i, yCoord);
                    firstPoint = false;
                } else {
                    lessonCtx.lineTo(i, yCoord);
                }
            }
            lessonCtx.stroke();

            // Add labels
            lessonCtx.font = '12px Inter';
            lessonCtx.fillStyle = f.color;
            // Place labels strategically to avoid overlap
            let yPos;
            if (graphType === 'linear') yPos = H - 40;
            else if (graphType === 'quadratic') yPos = 30;
            else if (graphType === 'exponential') yPos = 60;
            
            lessonCtx.fillText(f.label, W - 100, yPos);
        };

        if (type === 'comparison') {
            drawSingleGraph('linear');
            drawSingleGraph('quadratic');
            drawSingleGraph('exponential');
        } else {
            drawSingleGraph(type);
        }

        lessonCtx.fillStyle = '#d1d5db';
    }


    // --- Builder Functions (Draws to plotCanvas) ---

    function initializeBuilderElements() {
        // Get references to the elements in the dynamically added builder section
        functionSelect = builderSection.querySelector('#function-select');
        currentEquation = builderSection.querySelector('#current-equation');
        builderTable = builderSection.querySelector('#builder-table');
        plotButton = builderSection.querySelector('#plot-button');
        
        const plotCanvasContainer = builderSection.querySelector('#plot-canvas-container');
        // Re-append the canvas to the builder section
        plotCanvasContainer.appendChild(plotCanvas || (plotCanvas = document.createElement('canvas')));
        plotCanvas.id = 'plot-canvas';
        plotCtx = plotCanvas.getContext('2d');

        // Populate the select box
        functionSelect.innerHTML = Object.keys(FUNCTION_DATA).map(key => {
            const data = FUNCTION_DATA[key];
            return `<option value="${key}">${data.eqText}</option>`;
        }).join('');

        // Event Listeners
        functionSelect.onchange = (e) => {
            currentFunctionKey = e.target.value;
            updateTable();
            plotPoints(false); // Clear and redraw empty graph
        };
        plotButton.onclick = plotPoints;

        // Initial load for builder UI
        updateTable();
        setupPlotCanvas(); 
        plotPoints(false); 
        
        // Setup the next button to move to the result step once the user hits "Check My Work"
        nextButton.onclick = () => {
            plotPoints(true); // Run check and allow advancement
        };
    }

    // Expose clearFeedback globally
    window.clearFeedback = () => {
        feedbackMessage.textContent = '';
        feedbackMessage.style.color = '#9ca3af';
    };

    function updateTable() {
        const data = FUNCTION_DATA[currentFunctionKey];
        currentEquation.textContent = `Equation: ${data.eqText}`;

        let tableHtml = `
            <thead>
                <tr><th>x (Input)</th><th>y (Your Value)</th></tr>
            </thead>
            <tbody>
        `;
        data.xValues.forEach(x => {
            tableHtml += `
                <tr>
                    <td>${x}</td>
                    <td><input type="number" data-x="${x}" class="y-input" oninput="clearFeedback()"></td>
                </tr>
            `;
        });
        tableHtml += '</tbody>';
        builderTable.innerHTML = tableHtml;
        plotPoints(false); // Clear the plot when the function changes
    }

    function plotPoints(allowAdvance = false) {
        const data = FUNCTION_DATA[currentFunctionKey];
        const inputs = builderSection.querySelectorAll('.y-input');
        let points = [];
        let allFilled = true;

        inputs.forEach(input => {
            const x = parseFloat(input.dataset.x);
            const y = parseFloat(input.value);

            if (input.value.trim() === '') {
                allFilled = false;
            } else if (!isNaN(y)) {
                points.push({ x: x, y: y });
            }
        });
        
        // Redraw canvas with the current points
        drawPlot(points, data.equation, data.color, data.eqText);
        
        // Check correctness and provide feedback
        const correctCount = checkCorrectness(points, data.equation);
        const totalPoints = data.xValues.length;

        if (allowAdvance) {
            // Logic when the main "Check My Work" button is pressed
            if (correctCount === totalPoints) {
                feedbackMessage.textContent = 'Excellent! Your table is perfect. Click Next to finish the lesson.';
                feedbackMessage.style.color = '#10b981';
                nextButton.textContent = 'Next';
                nextButton.disabled = false;
            } else {
                feedbackMessage.textContent = `You had ${correctCount} of ${totalPoints} points correct. Correct the red dots and try again!`;
                feedbackMessage.style.color = '#ef4444';
                nextButton.textContent = 'Check My Work'; // Keep on this step until correct
                nextButton.disabled = false;
            }
            feedbackMessage.classList.remove('hidden');
        } else {
            // Plot Points button clicked (in-step visualization)
            if (points.length === 0) {
                clearFeedback();
            } else if (points.length !== totalPoints) {
                feedbackMessage.textContent = `Plotting ${points.length} of ${totalPoints} points. Fill all cells to check your work!`;
                feedbackMessage.style.color = '#f59e0b';
                feedbackMessage.classList.remove('hidden');
            } else if (correctCount === totalPoints) {
                feedbackMessage.textContent = 'All points look correct! Ready to check your final answer.';
                feedbackMessage.style.color = '#10b981';
                feedbackMessage.classList.remove('hidden');
            } else {
                feedbackMessage.textContent = `Plotted ${points.length} points. ${correctCount} correct. The correct shape is drawn in dashed line!`;
                feedbackMessage.style.color = '#ef4444';
                feedbackMessage.classList.remove('hidden');
            }
        }
    }

    function checkCorrectness(points, equation) {
        let correctCount = 0;
        points.forEach(point => {
            const expectedY = equation(point.x);
            if (Math.abs(point.y - expectedY) < 0.1) {
                correctCount++;
            }
        });
        return correctCount;
    }

    function setupPlotCanvas() {
        // Match canvas size to its container
        const container = plotCanvas.parentElement;
        plotCanvas.width = container.clientWidth;
        plotCanvas.height = 350;
        plotCtx.lineWidth = 2;
    }

    function drawPlot(points, equation, color, eqText) {
        setupPlotCanvas(); 
        plotCtx.clearRect(0, 0, plotCanvas.width, plotCanvas.height);
        
        const W = plotCanvas.width;
        const H = plotCanvas.height;
        const padding = 40;
        const xStart = padding;
        const xEnd = W - padding;
        const yStart = padding;
        const yEnd = H - padding;

        // --- 1. Determine Scaling ---
        const xInputs = FUNCTION_DATA[currentFunctionKey].xValues;
        let yValuesForRange = xInputs.map(x => equation(x));
        
        let xMin = Math.min(...xInputs);
        let xMax = Math.max(...xInputs);
        let yMin = Math.min(...yValuesForRange, 0);
        let yMax = Math.max(...yValuesForRange, 0);

        const yBuffer = (yMax - yMin) * 0.15 || 5;
        yMin -= yBuffer;
        yMax += yBuffer;
        
        const xRange = xMax - xMin;
        const yRange = yMax - yMin;
        
        const xScale = (xEnd - xStart) / xRange;
        const yScale = (yEnd - yStart) / yRange;
        
        const xToPx = (x) => xStart + (x - xMin) * xScale;
        const yToPx = (y) => yEnd - (y - yMin) * yScale;
        
        // --- 2. Draw Axes and Grid ---
        plotCtx.strokeStyle = '#374151'; // Grid/Axis color

        // Draw X-Axis (where y=0)
        const xAxisY = yToPx(0);
        if (xAxisY >= yStart && xAxisY <= yEnd) {
            plotCtx.beginPath();
            plotCtx.moveTo(xStart, xAxisY);
            plotCtx.lineTo(xEnd, xAxisY);
            plotCtx.stroke();
        }

        // Draw Y-Axis (where x=0)
        const yAxisX = xToPx(0);
        if (yAxisX >= xStart && yAxisX <= xEnd) {
            plotCtx.beginPath();
            plotCtx.moveTo(yAxisX, yStart);
            plotCtx.lineTo(yAxisX, yEnd);
            plotCtx.stroke();
        }

        // Draw main border axes
        plotCtx.strokeStyle = '#4b5563';
        plotCtx.beginPath();
        plotCtx.moveTo(xStart, yStart);
        plotCtx.lineTo(xStart, yEnd);
        plotCtx.lineTo(xEnd, yEnd);
        plotCtx.stroke();

        // --- 3. Draw Expected Function (Light Curve) ---
        plotCtx.beginPath();
        plotCtx.setLineDash([2, 4]); // Dashed line
        plotCtx.strokeStyle = color + '99'; // Lighter version of the main color
        
        let firstPoint = true;
        
        for (let px = xStart; px <= xEnd; px += 1) {
            const xDomain = xMin + (px - xStart) / xScale;
            const yVal = equation(xDomain);
            const py = yToPx(yVal);

            if (py < yStart || py > yEnd) {
                firstPoint = true;
                continue;
            }

            if (firstPoint) {
                plotCtx.moveTo(px, py);
                firstPoint = false;
            } else {
                plotCtx.lineTo(px, py);
            }
        }
        plotCtx.stroke();
        plotCtx.setLineDash([]); // Reset line style

        // --- 4. Draw User's Points ---
        points.forEach(point => {
            const xCoord = xToPx(point.x);
            const yCoord = yToPx(point.y);

            const expectedY = equation(point.x);
            const isCorrect = Math.abs(point.y - expectedY) < 0.1;
            
            plotCtx.fillStyle = isCorrect ? '#10b981' : '#ef4444'; // Green or Red
            
            plotCtx.beginPath();
            plotCtx.arc(xCoord, yCoord, 5, 0, Math.PI * 2);
            plotCtx.fill();
        });
        
        // --- 5. Draw Labels ---
        plotCtx.fillStyle = '#d1d5db';
        plotCtx.font = '14px Inter';
        plotCtx.fillText(eqText, xEnd - 100, yStart + 20);
    }

    // --- Initialization ---

    window.onload = () => {
        loadStep();
    };

    // Re-setup canvas on window resize to ensure responsiveness
    window.addEventListener('resize', () => {
        // If in lesson visual step
        const step = lessonData[currentStep];
        if (step.visualType) {
            setTimeout(() => {
                setupLessonCanvas();
                drawLessonGraph(step.visualType);
            }, 100);
        }
        // If in builder step
        if (isBuilderMode && plotCanvas) {
            setTimeout(plotPoints, 100);
        }
    });
</script>
</body>
</html>
