<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Practice: Bars & Pies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Set the initial state of the lines to be "undrawn" */
        #y-axis-path, #x-axis-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }
        /* This class will be added by JS to trigger the animation */
        .draw-line {
            animation: draw 2s ease-out forwards;
        }
        .fade-in {
            opacity: 0;
            animation: fade-in 1s ease-in forwards;
        }
        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }
        @keyframes fade-in {
            to {
                opacity: 1;
            }
        }
        /* Animation for bar-to-pie transform */
        .bar-to-pie-bar {
            transition: height 0.8s ease-in-out, y 0.8s ease-in-out;
        }
        .pie-slice {
            transition: opacity 0.5s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Name Entry Modal -->
    <div id="name-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center w-11/12 max-w-lg transform transition-all">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Welcome to Chart Practice!</h2>
            <p class="text-gray-600 mb-6">Please enter your name to begin.</p>
            <div class="my-6">
                <label for="student-name" class="sr-only">Your Name</label>
                <input type="text" id="student-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your name here">
            </div>
            <button id="start-lesson-btn" class="w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105">Start Lesson</button>
        </div>
    </div>

    <!-- Intro Modal 1: The Basics -->
    <div id="intro-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center w-11/12 max-w-lg transform transition-all">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Let's Start with the Basics!</h2>
            <div class="flex justify-center my-6">
                <svg class="w-48 h-48" viewBox="0 0 130 130" aria-hidden="true">
                    <path id="y-axis-path" d="M20, 110 L20, 10" stroke="#3B82F6" stroke-width="2.5"></path>
                    <path id="x-axis-path" d="M20, 110 L120, 110" stroke="#3B82F6" stroke-width="2.5"></path>
                    <text id="y-axis-text" x="-60" y="8" transform="rotate(-90)" class="fade-in" style="font-size: 12px; font-weight: 600; fill: #1E40AF; font-family: 'Inter', sans-serif; text-anchor: middle;">y-axis (vertical)</text>
                    <text id="x-axis-text" x="70" y="125" class="fade-in" style="font-size: 12px; font-weight: 600; fill: #1E40AF; font-family: 'Inter', sans-serif; text-anchor: middle;">x-axis (horizontal)</text>
                </svg>
            </div>
            <p id="intro-text" class="text-gray-700 font-medium mb-8 fade-in">Remember: The <strong class="font-semibold text-blue-700">x-axis</strong> is horizontal, and the <strong class="font-semibold text-blue-700">y-axis</strong> is vertical.</p>
            <button id="next-btn-1" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105">Next</button>
        </div>
    </div>
    
    <!-- Intro Modal 2: Y-Axis Explanation -->
    <div id="y-axis-explanation-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center w-11/12 max-w-lg transform transition-all opacity-0">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">What Goes on the Y-Axis?</h2>
            <p class="text-gray-700 font-medium mb-6">The y-axis (vertical) shows the <strong class="font-semibold text-blue-700">amount</strong> or <strong class="font-semibold text-blue-700">measurement</strong>. It answers "how much?" or "how many?".</p>
            <button id="next-btn-2" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105 mt-8">Next</button>
        </div>
    </div>

    <!-- Intro Modal 3: X-Axis Explanation -->
    <div id="x-axis-explanation-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-30 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center w-11/12 max-w-lg transform transition-all opacity-0">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">What Goes on the X-Axis?</h2>
            <p class="text-gray-700 font-medium mb-6">The x-axis (horizontal) shows the different <strong class="font-semibold text-blue-700">categories</strong> or <strong class="font-semibold text-blue-700">groups</strong> you are comparing.</p>
            <button id="start-bar-practice-btn" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105 mt-8">Start Bar Chart Practice</button>
        </div>
    </div>

    <!-- Intro Modal 4: Pie Chart Intro (Transition) -->
    <div id="pie-chart-intro-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-20 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center w-11/12 max-w-2xl transform transition-all opacity-0">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">From Bars to Pies!</h2>
            <p class="text-gray-700 font-medium mb-6">Great job! Now let's see how to show parts of a <strong class="font-semibold text-purple-700">whole</strong> with a <strong class="font-semibold text-purple-700">Pie Chart</strong>.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-8 my-6">
                <!-- Bar Chart SVG -->
                <svg id="bar-anim-svg" class="w-48 h-48" viewBox="0 0 100 100">
                    <rect id="bar-anim-1" class="bar-to-pie-bar" x="10" y="20" width="15" height="80" fill="#3B82F6"/>
                    <rect id="bar-anim-2" class="bar-to-pie-bar" x="30" y="40" width="15" height="60" fill="#EF4444"/>
                    <rect id="bar-anim-3" class="bar-to-pie-bar" x="50" y="70" width="15" height="30" fill="#10B981"/>
                    <rect id="bar-anim-4" class="bar-to-pie-bar" x="70" y="60" width="15" height="40" fill="#F59E0B"/>
                </svg>
                <!-- Pie Chart SVG -->
                <svg id="pie-anim-svg" class="w-48 h-48" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#E5E7EB" stroke-width="10"/>
                    <path id="pie-slice-1" class="pie-slice" d="M 50,50 L 50,5 A 45,45 0 0,1 92.45,69.13 Z" fill="#3B82F6" stroke-width="1" stroke="#fff"/>
                    <path id="pie-slice-2" class="pie-slice" d="M 50,50 L 92.45,69.13 A 45,45 0 0,1 21.21,83.13 Z" fill="#EF4444" stroke-width="1" stroke="#fff"/>
                    <path id="pie-slice-3" class="pie-slice" d="M 50,50 L 21.21,83.13 A 45,45 0 0,1 29.39,17.2 Z" fill="#10B981" stroke-width="1" stroke="#fff"/>
                    <path id="pie-slice-4" class="pie-slice" d="M 50,50 L 29.39,17.2 A 45,45 0 0,1 50,5 Z" fill="#F59E0B" stroke-width="1" stroke="#fff"/>
                </svg>
            </div>
            <button id="start-pie-practice-btn" class="w-full bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-600 transition-transform transform hover:scale-105 mt-8">Continue to Pie Charts</button>
        </div>
    </div>

    <!-- Main Quiz Container -->
    <div id="quiz-container" class="min-h-screen w-full flex flex-col items-center justify-center p-4 hidden">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Chart Practice</h1>
            <p class="text-gray-500 mt-2">Test your skills by reading the charts and answering the questions.</p>
        </header>

        <div id="main-content" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-4xl">
            <main class="flex flex-col gap-8">
                <div class="bg-gray-50 p-4 rounded-xl flex items-center justify-center min-h-[300px] md:min-h-[400px]">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div class="flex flex-col justify-between">
                    <div>
                        <div id="question-container" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-4">
                            <p class="font-semibold text-lg text-gray-700" id="question-text">Loading question...</p>
                        </div>
                        <div id="quiz-area">
                            <label for="user-answer" class="block text-sm font-medium text-gray-600 mb-2">Your Answer:</label>
                            <input type="text" id="user-answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Type your answer here">
                            <div id="feedback" class="mt-3 text-sm font-medium h-5"></div>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="check-answer" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600">Check Answer</button>
                        <button id="next-question" class="w-full bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800">Next Question</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Completion Modal -->
    <div id="completion-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-11/12 max-w-md transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Great Job!</h2>
            <p class="text-gray-600 mb-6">You've completed the practice session!</p>
            <div class="text-2xl font-bold mb-6">
                <span class="text-green-500" id="score">0</span> / <span id="total-questions">0</span> Correct
            </div>
            <button id="restart-quiz" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600">Practice Again</button>
        </div>
    </div>

    <script>
        const chartCanvas = document.getElementById('chartCanvas');
        const questionTextEl = document.getElementById('question-text');
        const userAnswerEl = document.getElementById('user-answer');
        const checkAnswerBtn = document.getElementById('check-answer');
        const nextQuestionBtn = document.getElementById('next-question');
        const feedbackEl = document.getElementById('feedback');
        const completionModal = document.getElementById('completion-modal');
        const restartQuizBtn = document.getElementById('restart-quiz');
        const scoreEl = document.getElementById('score');
        const totalQuestionsEl = document.getElementById('total-questions');
        
        // Modals
        const nameModal = document.getElementById('name-modal');
        const introModal = document.getElementById('intro-modal');
        const yAxisExplanationModal = document.getElementById('y-axis-explanation-modal');
        const xAxisExplanationModal = document.getElementById('x-axis-explanation-modal');
        const pieChartIntroModal = document.getElementById('pie-chart-intro-modal');
        const quizContainer = document.getElementById('quiz-container');

        // Buttons
        const startLessonBtn = document.getElementById('start-lesson-btn');
        const nextBtn1 = document.getElementById('next-btn-1');
        const nextBtn2 = document.getElementById('next-btn-2');
        const startBarPracticeBtn = document.getElementById('start-bar-practice-btn');
        const startPiePracticeBtn = document.getElementById('start-pie-practice-btn');

        // Animation elements
        const yAxisPath = document.getElementById('y-axis-path');
        const xAxisPath = document.getElementById('x-axis-path');
        const yAxisText = document.getElementById('y-axis-text');
        const xAxisText = document.getElementById('x-axis-text');
        const introText = document.getElementById('intro-text');

        let chartInstance;
        let currentQuestionSet;
        let currentQuestionIndex = 0;
        let score = 0;
        let studentId = 'Anonymous';
        let barQuestions = [];
        let pieQuestions = [];
        let pieAnimationInterval = null;
        let quizResults = [];

        const datasets = [
             {
                title: "Favorite Pets in Class 5B", type: 'bar', labels: ["Dog", "Cat", "Fish", "Rabbit", "Hamster"], data: [12, 8, 5, 4, 6],
                xAxisLabel: "Type of Pet", yAxisLabel: "Number of Students", backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)',
                questions: [ 
                    { q_id: "pets_q1", q: "Which axis runs horizontally (side to side)?", a: ["x-axis", "x axis", "x"] }, 
                    { q_id: "pets_q2", q: "What does the y-axis show?", a: ["Number of Students", "Students"] }, 
                    { q_id: "pets_q3", q: "What is the most popular pet?", a: ["Dog"] }, 
                    { q_id: "pets_q4", q: "How many more students chose Dog than Rabbit?", a: ["8"] },
                    { q_id: "pets_q5", q: "What is the least popular pet?", a: ["Rabbit"] },
                    { q_id: "pets_q6", q: "How many students chose Cat?", a: ["8"] },
                    { q_id: "pets_q7", q: "How many students are in Class 5B in total?", a: ["35"] },
                    { q_id: "pets_q8", q: "How many students chose either a Cat or a Dog?", a: ["20"] }
                ]
            },
            {
                title: "Fruits Sold at a Farm Stand", type: 'bar', labels: ["Apples", "Oranges", "Bananas", "Grapes", "Pears"], data: [45, 30, 55, 25, 40],
                xAxisLabel: "Type of Fruit", yAxisLabel: "Quantity Sold", backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)',
                questions: [ 
                    { q_id: "fruits_q1", q: "What is shown on the x-axis?", a: ["Type of Fruit", "Fruit", "Fruits"] }, 
                    { q_id: "fruits_q2", q: "Which fruit was sold the most?", a: ["Bananas", "Banana"] }, 
                    { q_id: "fruits_q3", q: "How many fruits were sold in total?", a: ["195"] },
                    { q_id: "fruits_q4", q: "Which fruit was sold the least?", a: ["Grapes"] },
                    { q_id: "fruits_q5", q: "How many more Bananas were sold than Grapes?", a: ["30"] },
                    { q_id: "fruits_q6", q: "How many Apples were sold?", a: ["45"] }
                ]
            },
            {
                title: "Average Monthly Temperature (째C)", type: 'bar', labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"], data: [8, 10, 14, 18, 22, 26, 28],
                xAxisLabel: "Month", yAxisLabel: "Temperature (째C)", backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)',
                questions: [ 
                    { q_id: "temp_q1", q: "What does the y-axis measure?", a: ["Temperature (째C)", "Temperature", "Temp"] }, 
                    { q_id: "temp_q2", q: "What was the average temperature in May?", a: ["22"] }, 
                    { q_id: "temp_q3", q: "Which month was the warmest?", a: ["Jul", "July"] }, 
                    { q_id: "temp_q4", q: "What is happening to the temperature between Jan and Jul?", a: ["increasing", "rising", "going up"] },
                    { q_id: "temp_q5", q: "Which month was the coldest?", a: ["Jan", "January"] },
                    { q_id: "temp_q6", q: "What was the temperature difference between July and January?", a: ["20"] },
                    { q_id: "temp_q7", q: "What was the temperature in March?", a: ["14"] },
                    { q_id: "temp_q8", q: "Which month had an average temperature of 10째C?", a: ["Feb", "February"] }
                ]
            },
            {
                title: "Number of Boys and Girls in Year 7", type: 'grouped', labels: ["7A", "7B", "7C"], xAxisLabel: "Tutor Group", yAxisLabel: "Number of Students",
                groupedData: [ { label: 'Boys', data: [14, 12, 15], backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)' }, { label: 'Girls', data: [16, 12, 13], backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)' }],
                questions: [ 
                    { q_id: "grouped_q1", q: "How many girls are in tutor group 7A?", a: ["16"] }, 
                    { q_id: "grouped_q2", q: "Which tutor group has the same number of boys and girls?", a: ["7B", "7b"] }, 
                    { q_id: "grouped_q3", q: "How many boys are there in Year 7 in total?", a: ["41"] },
                    { q_id: "grouped_q4", q: "How many students are in tutor group 7C in total?", a: ["28"] },
                    { q_id: "grouped_q5", q: "Which tutor group has the most students?", a: ["7A", "7a"] },
                    { q_id: "grouped_q6", q: "How many more girls than boys are there in 7A?", a: ["2"] },
                    { q_id: "grouped_q7", q: "How many girls are there in Year 7 in total?", a: ["41"] }
                ]
            },
            {
                title: "Favorite School Subjects", type: 'pie', labels: ["Math", "Science", "Art", "History", "English"], data: [10, 8, 6, 5, 9],
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'],
                questions: [ 
                    { q_id: "pie_q1", q: "Which subject is the most popular?", a: ["Math", "Maths"] }, 
                    { q_id: "pie_q2", q: "Which subject is the least popular?", a: ["History"] }, 
                    { q_id: "pie_q3", q: "How many students chose Science?", a: ["8"] }, 
                    { q_id: "pie_q4", q: "How many more students chose Math than Art?", a: ["4"] },
                    { q_id: "pie_q5", q: "How many students were surveyed in total?", a: ["38"] },
                    { q_id: "pie_q6", q: "Which subject got 9 votes?", a: ["English"] },
                    { q_id: "pie_q7", q: "How many students chose Art or History?", a: ["11"] }
                ]
            }
        ];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            barQuestions = [];
            pieQuestions = [];
            datasets.forEach(dataset => {
                const chartConfig = { ...dataset };
                delete chartConfig.questions;
                dataset.questions.forEach(q_and_a => {
                    const questionData = { ...q_and_a, chartConfig };
                    if (dataset.type === 'pie') {
                        pieQuestions.push(questionData);
                    } else {
                        barQuestions.push(questionData);
                    }
                });
            });
            shuffleArray(barQuestions);
            shuffleArray(pieQuestions);
        }

        function loadQuestion(index) {
            const question = currentQuestionSet[index];
            questionTextEl.textContent = question.q;
            userAnswerEl.value = '';
            feedbackEl.textContent = '';
            userAnswerEl.disabled = false;
            checkAnswerBtn.disabled = false;
            userAnswerEl.focus();

            if (chartInstance) chartInstance.destroy();

            const config = question.chartConfig;
            let chartType = config.type === 'grouped' ? 'bar' : config.type;
            let chartData = {
                labels: config.labels,
                datasets: config.type === 'grouped' ? config.groupedData.map(d => ({ ...d, borderWidth: 1, borderRadius: 5 })) :
                          config.type === 'pie' ? [{ data: config.data, backgroundColor: config.backgroundColor, borderWidth: 2, borderColor: '#fff' }] :
                          [{ label: config.title, data: config.data, backgroundColor: config.backgroundColor, borderColor: config.borderColor, borderWidth: 1, borderRadius: 5 }]
            };

            let options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: chartType === 'pie', position: 'bottom' }, title: { display: true, text: config.title, font: { size: 18 } } } };
            if (chartType === 'bar') {
                options.scales = { y: { beginAtZero: true, title: { display: true, text: config.yAxisLabel, font: { weight: 'bold' } } }, x: { title: { display: true, text: config.xAxisLabel, font: { weight: 'bold' } } } };
            }
            chartInstance = new Chart(chartCanvas, { type: chartType, data: chartData, options: options });
        }
        
        function levenshteinDistance(s1, s2) { s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = []; for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i === 0) costs[j] = j; else if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(newValue, lastValue, costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; }

        function checkAnswer() {
            const userAnswer = userAnswerEl.value.trim();
            const currentQuestion = currentQuestionSet[currentQuestionIndex];
            const correctAnswers = currentQuestion.a;
            let isCorrect = false;
            const isNumeric = !isNaN(parseFloat(correctAnswers[0])) && isFinite(correctAnswers[0]);
            
            if (isNumeric) {
                isCorrect = correctAnswers.includes(userAnswer.toLowerCase());
            } else {
                for (const answer of correctAnswers) {
                    if (levenshteinDistance(userAnswer.toLowerCase(), answer.toLowerCase()) <= (answer.length > 8 ? 2 : 1)) {
                        isCorrect = true; break;
                    }
                }
            }

            if (isCorrect) { 
                feedbackEl.textContent = "Correct! Well done."; 
                feedbackEl.className = 'mt-3 text-sm font-medium h-5 text-green-500'; 
                score++; 
            } else { 
                feedbackEl.textContent = `Not quite. The correct answer is: ${correctAnswers[0]}`; 
                feedbackEl.className = 'mt-3 text-sm font-medium h-5 text-red-500'; 
            }
            
            quizResults.push({
                question_id: currentQuestion.q_id,
                question_text: currentQuestion.q,
                user_answer: userAnswer,
                correct_answer: correctAnswers[0],
                is_correct: isCorrect
            });

            userAnswerEl.disabled = true; 
            checkAnswerBtn.disabled = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= currentQuestionSet.length) {
                if (currentQuestionSet === barQuestions) {
                    quizContainer.classList.add('hidden');
                    pieChartIntroModal.classList.remove('hidden');
                    setTimeout(() => {
                        pieChartIntroModal.querySelector('div').classList.remove('opacity-0');
                        if (pieAnimationInterval) clearInterval(pieAnimationInterval);
                        runBarToPieAnimation();
                        pieAnimationInterval = setInterval(runBarToPieAnimation, 4500);
                    }, 10);
                } else {
                    showCompletion();
                }
            } else {
                loadQuestion(currentQuestionIndex);
            }
        }
        
        function showCompletion() {
            scoreEl.textContent = score;
            const total = barQuestions.length + pieQuestions.length;
            totalQuestionsEl.textContent = total;
            completionModal.classList.remove('hidden');
            setTimeout(() => completionModal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
            
            sendResultsToWebhook(score, total, quizResults);
        }

        async function sendResultsToWebhook(finalScore, totalQuestions, results) {
            const webhookUrl = 'https://automations.emoalchemy.com/webhook/chart-practice';
            
            // Create the base payload
            const payload = {
                student_id: studentId,
                activity_name: 'Chart Practice',
                final_score: finalScore,
                total_questions: totalQuestions,
                percentage: totalQuestions > 0 ? ((finalScore / totalQuestions) * 100).toFixed(2) : 0,
                timestamp: new Date().toISOString()
            };

            // Flatten the results array into the payload
            results.forEach(result => {
                payload[`${result.question_id}_answer`] = result.user_answer;
                payload[`${result.question_id}_correct`] = result.is_correct;
            });

            try {
                await fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                console.log('Quiz results sent to webhook. Note: Response status cannot be checked due to CORS policy.');
            } catch (error) {
                console.error('Error sending data to webhook:', error);
            }
        }

        function restartQuiz() {
            if (pieAnimationInterval) clearInterval(pieAnimationInterval);
            completionModal.classList.add('hidden');
            nameModal.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;
            quizResults = [];
            studentId = 'Anonymous';
            document.getElementById('student-name').value = '';
        }

        function startBarQuiz() {
            xAxisExplanationModal.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            currentQuestionSet = barQuestions;
            currentQuestionIndex = 0;
            loadQuestion(0);
        }
        
        function startPieQuiz() {
            if (pieAnimationInterval) clearInterval(pieAnimationInterval);
            pieChartIntroModal.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            currentQuestionSet = pieQuestions;
            currentQuestionIndex = 0;
            loadQuestion(0);
        }
        
        // --- Event Listeners ---
        checkAnswerBtn.addEventListener('click', checkAnswer);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        restartQuizBtn.addEventListener('click', restartQuiz);
        userAnswerEl.addEventListener('keypress', (e) => e.key === 'Enter' && !checkAnswerBtn.disabled && checkAnswer());
        
        startLessonBtn.addEventListener('click', () => {
            const nameInput = document.getElementById('student-name');
            studentId = nameInput.value.trim() || 'Anonymous';
            nameModal.classList.add('hidden');
            introModal.classList.remove('hidden');

            setTimeout(() => yAxisPath.classList.add('draw-line'), 500); 
            setTimeout(() => xAxisPath.classList.add('draw-line'), 2500);
            setTimeout(() => { 
                yAxisText.style.animationDelay = '0s'; 
                xAxisText.style.animationDelay = '0.2s'; 
                introText.style.animationDelay = '0.4s'; 
            }, 4500);
        });
        
        nextBtn1.addEventListener('click', () => { introModal.classList.add('hidden'); yAxisExplanationModal.classList.remove('hidden'); setTimeout(() => yAxisExplanationModal.querySelector('div').classList.remove('opacity-0'), 10); });
        nextBtn2.addEventListener('click', () => { yAxisExplanationModal.classList.add('hidden'); xAxisExplanationModal.classList.remove('hidden'); setTimeout(() => xAxisExplanationModal.querySelector('div').classList.remove('opacity-0'), 10); });
        startBarPracticeBtn.addEventListener('click', startBarQuiz);
        startPiePracticeBtn.addEventListener('click', startPieQuiz);

        // --- Animations ---
        function runBarToPieAnimation() {
            const bars = document.querySelectorAll('.bar-to-pie-bar');
            const slices = document.querySelectorAll('.pie-slice');
            
            slices.forEach(slice => slice.style.opacity = '0');
            bars.forEach(bar => {
                bar.style.height = '';
                bar.style.y = '';
            });

            setTimeout(() => {
                let delay = 500;
                bars.forEach((bar, index) => {
                    setTimeout(() => {
                        bar.style.height = '0';
                        bar.style.y = '100';
                        setTimeout(() => slices[index].style.opacity = '1', 400);
                    }, delay);
                    delay += 800;
                });
            }, 100);
        }
        
        window.addEventListener('load', () => {
            generateQuestions();
        });
    </script>
</body>
</html>
```

### New JSON Output (Wide Format)

Here is a sample of the new, flat JSON structure. The full output will be much larger, with a total of 78 fields (6 summary fields + 72 question fields).

```json
{
  "student_id": "Jane Doe",
  "activity_name": "Chart Practice",
  "final_score": 33,
  "total_questions": 36,
  "percentage": "91.67",
  "timestamp": "2025-09-16T17:12:00.123Z",
  "pets_q1_answer": "x-axis",
  "pets_q1_correct": true,
  "pets_q2_answer": "students",
  "pets_q2_correct": true,
  "fruits_q5_answer": "25",
  "fruits_q5_correct": false
}

