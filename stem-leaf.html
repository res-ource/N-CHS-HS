<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Stem-and-Leaf Plot Lab</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for plot structure, highlights, and stats output */
        .plot-container { font-family: 'Inter', monospace; display: flex; flex-direction: column; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .plot-row { display: flex; border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
        .stem-column { width: 50px; padding: 6px 10px; text-align: right; font-weight: 700; color: #1f2937; background-color: #f3f4f6; position: relative; }
        .leaf-column { flex-grow: 1; padding: 6px 10px; word-wrap: break-word; word-break: break-all; letter-spacing: 0.5em; color: #374151; }
        .stem-column::after { content: ""; position: absolute; top: 0; right: 0; width: 2px; height: 100%; background-color: #4b5563; }
        .key-line { font-size: 0.875rem; margin-top: 8px; padding: 8px; border-radius: 0.5rem; background-color: #fef3c7; border: 1px dashed #fbbf24; }
        .correct-answer { background-color: #d1fae5; border-color: #10b981; }
        .incorrect-answer { background-color: #fee2e2; border-color: #ef4444; }
        .draggable-raw { cursor: grab; }
        /* Add hover effect for drop zones */
        .plot-row-dynamic:hover { background-color: #f8f8f8; }
    </style>
    <script>
        let currentPage = 0;
        const maxPages = 4; // Pages 0 (Intro), 1 (Builder), 2 (Analysis), 3 (Report)
        let currentBuilderData = []; 
        let plotState = {}; 

        // SCORING TRACKERS
        let builderDataCompletion = [false, false, false, false]; // Tracks completion status for the 4 data sets (Max 4 points)
        let challengeScores = [0, 0, 0, 0]; // Tracks correct stats per challenge [C1_Score, C2_Score, C3_Score, C4_Score] (Max 6 points per challenge)
        let currentChallengeIndex = 0; // Index for the Interpretation Challenges

        // --- DATA SETS ---
        
        // Data sets for the D&D builder (Step 2)
        const dataSets = [
            { name: "1. Standard 2-Digit Scores (Mode: 27)", raw: [7, 8, 13, 15, 17, 22, 24, 25, 27, 27, 27, 28, 32, 43] },
            { name: "2. 3-Digit Numbers (Modes: 88, 102)", raw: [102, 108, 115, 72, 76, 85, 88, 88, 89, 93, 97, 113, 102] },
            { name: "3. Decimals (Modes: 4.2, 5.1)", raw: [3.1, 4.5, 5.7, 4.2, 3.4, 4.0, 5.1, 3.6, 4.2, 5.1] },
            { name: "4. Mixed Small & Large (Modes: 23, 25)", raw: [1, 2, 4, 11, 13, 14, 20, 21, 22, 23, 23, 24, 25, 25] },
        ];
        
        // Data sets and answers for the Interpretation Challenges (Step 3)
        const challengeSets = [
            // Challenge 1: Math Test Scores (Original Data)
            { id: 0, title: "Math Test Scores (Out of 100)", raw: [59, 62, 62, 65, 70, 75, 75, 78, 79, 81, 83, 88, 91, 95], keyText: "5 | 9 = 59", 
              answers: { min: 59, max: 95, range: 36, mode: "62, 75", median: 76.5, mean: 76.64 } },
            
            // Challenge 2: Daily Rainfall (Decimals)
            { id: 1, title: "Daily Rainfall (Inches)", raw: [0.3, 0.5, 0.7, 1.1, 1.1, 1.3, 1.6, 2.0, 2.4, 2.5], keyText: "0 | 3 = 0.3", 
              answers: { min: 0.3, max: 2.5, range: 2.2, mode: "1.1", median: 1.2, mean: 1.35 } },

            // Challenge 3: Marathon Times (3-Digit)
            { id: 2, title: "Marathon Times (Minutes)", raw: [153, 155, 161, 161, 161, 168, 170, 172, 174, 185], keyText: "15 | 3 = 153", 
              answers: { min: 153, max: 185, range: 32, mode: "161", median: 164.5, mean: 165.00 } },

            // Challenge 4: Customer Ages
            { id: 3, title: "Customer Ages (Years)", raw: [18, 18, 19, 21, 21, 22, 25, 30, 31, 31, 31, 32, 40, 40], keyText: "1 | 8 = 18", 
              answers: { min: 18, max: 40, range: 22, mode: "31", median: 27.5, mean: 27.14 } }
        ];

        // Pre-calculate challenge plot HTML once
        let challengePlotHtmls = {};


        function navigate(direction) {
            let newPage = currentPage + direction;
            if (newPage >= 0 && newPage < maxPages) { currentPage = newPage; showPage(currentPage); } 
            else if (newPage === maxPages) { currentPage = 0; showPage(currentPage); }
        }

        function parseData(input) {
            return input.split(',').map(s => s.trim()).filter(s => s !== '' && !isNaN(Number(s))).map(Number);
        }

        // --- CORE PLOTTING UTILITY ---
        function getStemLeaf(value) {
            value = Number(value);
            const str = value.toString();
            const decimalIndex = str.indexOf('.');
            const isDecimal = decimalIndex !== -1;

            if (isDecimal) {
                const parts = str.split('.');
                const stem = Number(parts[0]);
                const leaf = parts.length > 1 && parts[1].length > 0 ? Number(parts[1][0]) : 0;
                return { stem, leaf, fullValue: value };
            } else {
                const stem = Math.floor(value / 10) || 0;
                const leaf = value % 10;
                return { stem, leaf, fullValue: value };
            }
        }
        
        // --- DRAG AND DROP HANDLERS ---
        function handleDragStart(e) {
            const value = e.target.getAttribute('data-value');
            const id = e.target.getAttribute('data-id'); // Get unique ID
            e.dataTransfer.setData('text/plain', JSON.stringify({ value, id })); // Pass both
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('opacity-50', 'ring-4', 'ring-blue-400');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50', 'ring-4', 'ring-blue-400');
        }

        function handleDragOver(e) {
            e.preventDefault();
            
            let draggedData;
            try { draggedData = JSON.parse(e.dataTransfer.getData('text/plain')); } catch (error) { return; }
            const draggedValue = draggedData.value;
            
            if (!draggedValue) return;

            const { stem: expectedStem } = getStemLeaf(draggedValue);
            const targetStem = Number(e.currentTarget.getAttribute('data-stem'));

            if (targetStem === expectedStem) {
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('bg-blue-100');
            } else {
                e.dataTransfer.dropEffect = 'none';
                e.currentTarget.classList.add('bg-red-100');
            }
        }

        function handleDragLeave(e) {
             e.currentTarget.classList.remove('bg-blue-100', 'bg-red-100');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-blue-100', 'bg-red-100');

            let draggedData;
            try { draggedData = JSON.parse(e.dataTransfer.getData('text/plain')); } catch (error) { return; }
            const draggedValue = draggedData.value;
            const draggedId = draggedData.id;

            if (!draggedValue) return;

            const { stem, leaf } = getStemLeaf(draggedValue);
            const targetStem = Number(e.currentTarget.getAttribute('data-stem'));

            if (stem !== targetStem) { return; } 
            
            // Find the specific draggable element using data-id
            const draggable = document.querySelector(`.draggable-raw[data-id="${draggedId}"]`);
            if (draggable) {
                draggable.classList.add('hidden');
                
                if (!plotState[stem]) plotState[stem] = [];
                
                // Store the value and unique ID in plotState
                plotState[stem].push({ value: Number(draggedValue), leaf: leaf, id: draggedId });
                
                plotState[stem].sort((a, b) => a.leaf - b.leaf); 
                
                renderPlotRow(stem);
            }
        }

        function handleDropBack(e) {
            e.preventDefault();
            
            let draggedData;
            try { draggedData = JSON.parse(e.dataTransfer.getData('text/plain')); } catch (error) { return; }
            const draggedValue = draggedData.value;
            const draggedId = draggedData.id;

            if (!draggedValue) return;

            // Find the specific draggable element using data-id
            const draggable = document.querySelector(`.draggable-raw[data-id="${draggedId}"]`);

            if (draggable) {
                const { stem } = getStemLeaf(draggedValue);
                if (plotState[stem]) {
                    // Remove from state based on unique ID
                    plotState[stem] = plotState[stem].filter(l => l.id !== draggedId);
                    renderPlotRow(stem);
                }
                // Restore the specific draggable element
                draggable.classList.remove('hidden');
            }
        }


        function renderPlotRow(stem) {
            const leafContainer = document.getElementById(`leaf-col-${stem}`);
            if (leafContainer) {
                if (plotState[stem] && plotState[stem].length > 0) {
                    leafContainer.textContent = plotState[stem].map(l => l.leaf).join('');
                } else {
                    leafContainer.textContent = '';
                }
            }
        }
        
        // --- STATISTICAL FUNCTIONS (Used for checking answers) ---
        function calculateStatistics(data) {
            const sortedData = [...data].sort((a, b) => a - b);
            const count = sortedData.length;
            if (count === 0) return {};

            const sum = sortedData.reduce((acc, val) => acc + val, 0);
            const mean = (sum / count).toFixed(2);
            const min = sortedData[0];
            const max = sortedData[count - 1];
            const range = (max - min).toFixed(2);

            let median;
            const middle = Math.floor(count / 2);
            if (count % 2 === 0) {
                median = ((sortedData[middle - 1] + sortedData[middle]) / 2).toFixed(1);
            } else {
                median = sortedData[middle].toFixed(1);
            }

            const counts = sortedData.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            let maxCount = 0;
            let modes = [];
            for (const key in counts) {
                const currentCount = counts[key];
                if (currentCount > maxCount) {
                    maxCount = currentCount;
                    modes = [Number(key)];
                } else if (currentCount === maxCount && maxCount > 1) {
                    modes.push(Number(key));
                }
            }
            // Ensure single mode is formatted correctly, handle large numbers/decimals in mode array
            const mode = modes.length > 0 ? modes.sort((a, b) => a - b).map(m => {
                // Formatting decimals for modes to match input expectation
                return Math.abs(m % 1) !== 0 ? m.toFixed(1) : m.toString();
            }).join(', ') : 'None';


            return { min: min, max: max, range: parseFloat(range), mean: mean, median: median, mode: mode };
        }
        
        // --- PLOT STRUCTURE GENERATOR ---
        function createPlot(rawData) {
             const data = [...rawData].sort((a, b) => a - b);
            if (data.length === 0) return { html: "<p class='text-center text-red-500'>No data provided.</p>", key: "" };

            let minStem = getStemLeaf(data[0]).stem;
            let maxStem = getStemLeaf(data[data.length - 1]).stem;
            
            const plotMap = {};

            for (let value of data) {
                const { stem, leaf } = getStemLeaf(value);
                if (!plotMap[stem]) {
                    plotMap[stem] = [];
                }
                plotMap[stem].push(leaf);
            }

            let html = "";
            for (let stem = minStem; stem <= maxStem; stem++) {
                const leaves = plotMap[stem] || [];
                const leavesStr = leaves.map(l => l.toString()).join('');

                html += `
                    <div class="plot-row">
                        <div class="stem-column">${stem}</div>
                        <div class="leaf-column">${leavesStr}</div>
                    </div>
                `;
            }
            return { html: html, key: null };
        }


        function generatePlot() {
            const select = document.getElementById('data-set-select');
            const selectedIndex = Number(select.value);
            const dataSet = dataSets[selectedIndex];
            currentBuilderData = [...dataSet.raw];
            
            plotState = {};
            resetInputs('builder');
            
            const rawDataContainer = document.getElementById('raw-data-container');
            rawDataContainer.innerHTML = '';
            
            // 1. Render raw data numbers as draggables (shuffled)
            const shuffledData = shuffleArray([...dataSet.raw]);
            shuffledData.forEach((value, index) => { // Added index for unique ID generation
                const div = document.createElement('div');
                const uniqueId = `${value}-${index}`; // Unique ID per element
                
                div.textContent = value;
                div.className = 'draggable-raw p-2 border border-gray-400 bg-white rounded-lg shadow-sm cursor-grab text-center font-bold text-gray-800 transition hover:bg-yellow-50';
                div.setAttribute('draggable', 'true');
                div.setAttribute('data-value', value);
                div.setAttribute('data-id', uniqueId); // Set unique ID
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                rawDataContainer.appendChild(div);
            });

            // 2. Render the empty stem plot structure 
            const plotContainer = document.getElementById('plot-output-dnd');
            const keyDiv = document.getElementById('plot-key');
            plotContainer.innerHTML = '';
            
            if (dataSet.raw.length === 0) {
                plotContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Data set is empty.</p>';
                keyDiv.innerHTML = '';
                return;
            }

            const minStem = getStemLeaf(Math.min(...dataSet.raw)).stem;
            const maxStem = getStemLeaf(Math.max(...dataSet.raw)).stem;
            
            let keyText = "";

            for (let stem = minStem; stem <= maxStem; stem++) {
                plotState[stem] = []; 
                
                const row = document.createElement('div');
                row.className = 'plot-row plot-row-dynamic';
                row.setAttribute('data-stem', stem);
                row.ondragover = handleDragOver;
                row.ondragleave = handleDragLeave;
                row.ondrop = handleDrop;
                
                const stemCol = document.createElement('div');
                stemCol.className = 'stem-column';
                stemCol.textContent = stem;

                const leafCol = document.createElement('div');
                leafCol.className = 'leaf-column';
                leafCol.id = `leaf-col-${stem}`;
                leafCol.textContent = '';

                row.appendChild(stemCol);
                row.appendChild(leafCol);
                plotContainer.appendChild(row);
            }
            
            const firstValue = dataSet.raw.sort((a,b)=>a-b)[0];
            const { stem: fs, leaf: fl } = getStemLeaf(firstValue);
            keyText = `<span class="font-bold">${fs}</span> | <span class="font-bold">${fl}</span> = ${firstValue}`;
            
            keyDiv.innerHTML = `Key: ${keyText}`;
            document.getElementById('builder-check-message').innerHTML = '<p class="text-blue-600 mt-2">Plot structure ready! Drag all numbers to their correct Stem row.</p>';
        }

        // --- VALIDATION AND SCORING UTILITIES ---
        function resetInputs(prefix) {
            ['min', 'max', 'range', 'median', 'mode', 'mean'].forEach(stat => {
                const inputElement = document.getElementById(stat + `-${prefix}-input`); 
                if (inputElement && !inputElement.readOnly) { inputElement.value = ''; }
                if (inputElement) {
                    const container = inputElement.closest('.flex');
                    container.classList.remove('correct-answer', 'incorrect-answer', 'border-red-500', 'border-green-500');
                }
            });
            const messageEl = document.getElementById(`${prefix}-check-message`);
            if (messageEl) { messageEl.innerHTML = ''; }
        }
        
        function checkAnswers(prefix) {
            const isBuilder = prefix === 'builder';
            const currentChallenge = isBuilder ? null : challengeSets[currentChallengeIndex];
            const dataToUse = isBuilder ? currentBuilderData : currentChallenge.raw; 
            
            const dataReady = dataToUse && dataToUse.length >= 2;
            const currentDataSetIndex = isBuilder ? Number(document.getElementById('data-set-select').value) : -1;
            
            // 1. Plot Completion Check (Builder Only)
            let allNumbersPlotted = false;
            if (isBuilder) {
                const totalPlotted = Object.values(plotState).reduce((sum, arr) => sum + arr.length, 0);
                allNumbersPlotted = totalPlotted === dataToUse.length;
            }

            if (isBuilder && !dataReady) {
                document.getElementById('builder-check-message').innerHTML = `<p class="text-red-600 mt-2">Please select a data set and click "Load Data" first!</p>`;
                return;
            }

            if (isBuilder && !allNumbersPlotted) {
                 document.getElementById('builder-check-message').innerHTML = `<p class="text-red-600 mt-2">Please drag all numbers into the plot before checking statistics.</p>`;
                 return;
            }
            
            // 2. Statistic Calculation Check
            const correctAnswers = isBuilder ? calculateStatistics(dataToUse) : currentChallenge.answers;
            const messageId = `${prefix}-check-message`;
            let allStatsCorrect = true;
            let correctStatCount = 0;

            const statsList = ['min', 'max', 'range', 'median', 'mode', 'mean'];

            statsList.forEach(stat => {
                const inputId = `${stat}-${prefix}-input`;
                const inputElement = document.getElementById(inputId); 
                if (!inputElement) return;

                const value = inputElement.value.trim(); 
                const container = inputElement.closest('.flex');
                let isCorrect = false;
                let expectedAnswer = correctAnswers[stat].toString();

                if (stat === 'mode') {
                    const userModes = value.split(/,\s*|\s+/).map(s => s.trim()).filter(s => s !== '').map(Number).sort().join(',');
                    const expectedModes = expectedAnswer.split(/,\s*/).map(s => s.trim()).filter(s => s !== '').map(Number).sort().join(',');
                    isCorrect = userModes === expectedModes;
                } else if (stat === 'median' || stat === 'mean') {
                     isCorrect = value === expectedAnswer; 
                } else {
                    const numValue = Number(value);
                    const expectedNum = Number(expectedAnswer);
                    // Use a small epsilon for number comparison to handle floating point issues
                    isCorrect = !isNaN(numValue) && Math.abs(numValue - expectedNum) < 0.01;
                }

                container.classList.toggle('correct-answer', isCorrect); 
                container.classList.toggle('incorrect-answer', !isCorrect);
                
                if (isCorrect) {
                    correctStatCount++;
                } else if (!inputElement.readOnly) { 
                    allStatsCorrect = false; 
                }
            });

            // 3. SCORING AND FEEDBACK UPDATES
            const resultMessage = document.getElementById(messageId);
            const nextBtn = document.getElementById('analysis-next-btn');
            const skipBtn = document.getElementById('analysis-skip-btn');

            if (isBuilder && allStatsCorrect) {
                 builderDataCompletion[currentDataSetIndex] = true;
                 resultMessage.innerHTML = `<p class="text-green-700 font-bold mt-4">✅ All Correct! Data Set ${currentDataSetIndex + 1} Mastered. Try the other sets!</p>`;
            } else if (!isBuilder) {
                 // Store score for the current challenge (Max 6 points)
                 challengeScores[currentChallengeIndex] = correctStatCount;
                 
                 if (allStatsCorrect) {
                    resultMessage.innerHTML = `<p class="text-green-700 font-bold mt-4">✅ All Correct! Challenge ${currentChallengeIndex + 1} Mastered. Press "Next Challenge".</p>`;
                    nextBtn.disabled = false;
                    skipBtn.classList.add('hidden'); // Hide skip button on success
                 } else {
                    // **FIXED MESSAGE TO GUIDE USER TO SKIP BUTTON**
                    resultMessage.innerHTML = `<p class="text-red-700 font-bold mt-4">❌ Keep trying! You got ${correctStatCount}/6 correct. Review your calculations, or click the yellow button below to record your score and proceed.</p>`;
                    
                    // Show the skip option and update its message
                    skipBtn.classList.remove('hidden');
                    skipBtn.textContent = `Skip Challenge (Score ${correctStatCount}/6 Recorded) →`;
                    nextBtn.disabled = true;
                 }
            } else if (isBuilder && !allStatsCorrect) {
                resultMessage.innerHTML = `<p class="text-red-700 mt-4">❌ Keep trying! Review your calculations and try again.</p>`;
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- FINAL REPORT LOGIC ---
        function calculateFinalScore() {
            const builderPoints = builderDataCompletion.filter(c => c).length;
            const totalChallengeStatsCorrect = challengeScores.reduce((sum, score) => sum + score, 0);
            const totalChallengeStatsPossible = challengeSets.length * 6; // 4 challenges * 6 stats = 24

            // Normalize analysis score: max 6 points out of 24 possible stats
            const analysisPoints = Math.round((totalChallengeStatsCorrect / totalChallengeStatsPossible) * 6); 
            const totalPoints = builderPoints + analysisPoints; // Max 4 + 6 = 10

            document.getElementById('builder-score-out').textContent = `${builderPoints} / ${dataSets.length}`;
            document.getElementById('analysis-score-out').textContent = `${totalChallengeStatsCorrect} / ${totalChallengeStatsPossible} (${analysisPoints} pts)`;
            document.getElementById('total-score-out').textContent = `${totalPoints} / 10`;

            const message = document.getElementById('final-message');
            if (totalPoints === 10) {
                 message.innerHTML = '<span class="text-green-700 font-extrabold">🎉 Congratulations! Flawless mastery of Stem-and-Leaf Plots.</span>';
            } else if (totalPoints >= 7) {
                 message.innerHTML = '<span class="text-blue-700 font-extrabold">Great Job! You\'ve achieved high mastery. Consider re-attempting unfinished sections.</span>';
            } else {
                 message.innerHTML = '<span class="text-yellow-700 font-extrabold">Keep Practicing. Review the definitions of Median, Mode, and Mean, and try the challenges again.</span>';
            }
        }
        
        // --- CHALLENGE NAVIGATION AND RENDERING ---
        function generateChallengePlot(challengeIndex) {
            const challenge = challengeSets[challengeIndex];
            
            // If the plot hasn't been cached, generate it now
            if (!challengePlotHtmls[challenge.id]) {
                challengePlotHtmls[challenge.id] = createPlot(challenge.raw);
            }
            const plotHtml = challengePlotHtmls[challenge.id];

            document.getElementById('analysis-title').textContent = `Challenge ${challengeIndex + 1} of ${challengeSets.length}: ${challenge.title}`;
            document.getElementById('analysis-plot-output').innerHTML = `<div class="plot-container rounded-xl">${plotHtml.html}</div>`;
            document.getElementById('analysis-key').innerHTML = `Key: ${challenge.keyText}`;

            // Reset inputs and messages for the new challenge
            resetInputs('analysis');
            document.getElementById('analysis-next-btn').disabled = true;
            document.getElementById('analysis-skip-btn').classList.add('hidden'); // Hide skip button on load

            // Pre-fill Min/Max if desired (Min and Max are visually obvious and speed up the rest of the calculation)
            document.getElementById('min-analysis-input').value = challenge.answers.min;
            document.getElementById('max-analysis-input').value = challenge.answers.max;
        }

        function nextChallenge() {
            // Check if the current challenge has been mastered (score 6) OR if the skip button was clicked
            if (currentChallengeIndex < challengeSets.length - 1) {
                currentChallengeIndex++;
                generateChallengePlot(currentChallengeIndex);
            } else {
                // All challenges complete, move to the final report
                navigate(1);
            }
        }


        // --- PAGE NAVIGATION ---
        
        function showPage(index) {
            document.querySelectorAll('.page-content').forEach(d => d.classList.add('hidden'));
            const pageEl = document.getElementById(`page-${index}`); if (!pageEl) return;
            pageEl.classList.remove('hidden');

            const prevBtn = pageEl.querySelector('.page-prev-btn'); const nextBtn = pageEl.querySelector('.page-next-btn');
            
            if (index === 1) {
                const select = document.getElementById('data-set-select');
                if (select.children.length === 0) {
                     dataSets.forEach((set, i) => {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = set.name;
                        select.appendChild(option);
                    });
                     if (currentBuilderData.length === 0) generatePlot(); 
                }
                const rawDataContainer = document.getElementById('raw-data-container');
                rawDataContainer.ondragover = (e) => e.preventDefault();
                rawDataContainer.ondrop = handleDropBack;
            } else if (index === 2) {
                 // Start or resume the interpretation challenge
                 currentChallengeIndex = 0; // Always start at the first challenge when entering the page
                 generateChallengePlot(currentChallengeIndex); 
            } else if (index === 3) {
                 calculateFinalScore();
            }

            if (prevBtn) { prevBtn.onclick = () => navigate(-1); prevBtn.classList.toggle('invisible', index === 0); }
            if (nextBtn) {
                if (index === 2) {
                    // For challenge page, the 'Next Step' button is hidden and 'Next Challenge' is used
                    nextBtn.classList.add('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    nextBtn.disabled = false; nextBtn.onclick = () => navigate(1); 
                    nextBtn.textContent = (index === maxPages - 1) ? 'Start Over' : 'Next Step →';
                }
            }
        }

        window.onload = () => {
            document.getElementById('generate-plot-btn').addEventListener('click', generatePlot);
            document.getElementById('check-builder-btn').addEventListener('click', () => checkAnswers('builder'));
            document.getElementById('check-analysis-btn').addEventListener('click', () => checkAnswers('analysis'));
            document.getElementById('analysis-next-btn').addEventListener('click', nextChallenge);
            // The skip button uses nextChallenge() directly via inline HTML `onclick`
            document.getElementById('data-set-select').addEventListener('change', generatePlot);
            showPage(currentPage);
        };
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-[Inter] text-gray-800">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700 tracking-tight">Stem-and-Leaf Plot Lab (D&D Edition)</h1>
            <p class="text-xl text-gray-600 mt-2">Build Plots & Analyze Key Statistics</p>
        </header>
        
        <!-- PAGE 0: INTRODUCTION & CORE PROCESS -->
        <div id="page-0" class="page-content">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-3xl font-bold mb-4 text-blue-700">Step 1: The Core Rule</h2>
                <p class="mb-6 text-gray-600">A **Stem-and-Leaf Plot** separates a data point into two parts: the **Stem** (leading digit/digits) and the **Leaf** (always the single, final digit).</p>
                <div class="flex justify-around items-center text-center p-4 mt-6 bg-yellow-100 border border-yellow-300 rounded-lg">
                    <div class="space-y-1"><p class="text-xl font-bold text-blue-700">STEM: 8</p><p class="text-sm text-gray-600">(Leading Digits)</p></div>
                    <div class="text-3xl font-bold text-gray-500 py-2 sm:py-0">+</div>
                    <div class="space-y-1"><p class="text-xl font-bold text-red-700">LEAF: 3</p><p class="text-sm text-gray-600">(Final Digit)</p></div>
                    <div class="text-3xl font-bold text-gray-500 py-2 sm:py-0">→</div>
                    <div class="space-y-1"><p class="text-3xl font-extrabold text-gray-900">83</p><p class="text-sm text-gray-600">(Data Point)</p></div>
                </div>
                <h3 class="font-extrabold text-xl mt-6 mb-3 text-gray-900">The Construction Requirements</h3>
                <ul class="list-disc list-inside text-lg font-medium space-y-2 p-4 bg-gray-100 rounded-lg">
                    <li>**Order the Data:** Numbers must be sorted from smallest to largest.</li>
                    <li>**Plot Leaves:** Leaves must be listed in **ascending order** for each stem.</li>
                    <li>**Create the Key:** The plot must include a key (e.g., $3|1 = 31$) to define the place value.</li>
                </ul>
                <div class="flex justify-end items-center mt-6 pt-4 border-t border-gray-200">
                    <button class="page-next-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">Next Step →</button>
                </div>
            </div>
        </div>

        <!-- PAGE 1: DRAG AND DROP BUILDER & STATS (Self-Check) -->
        <div id="page-1" class="page-content hidden">
            <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-3xl font-bold mb-4 text-blue-700">Step 2: Plot Builder (Drag & Drop)</h2>
                <p class="mb-4 text-gray-600">Select a data set, then **drag each raw number** from the container below to its correct **Stem row** to construct the plot. Then, manually calculate the statistics.</p>
                
                <div class="space-y-4 mb-6">
                    <label for="data-set-select" class="font-bold text-gray-700 block">Choose a Data Set to Build:</label>
                    <div class="flex gap-2">
                        <select id="data-set-select" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options populated by JS -->
                        </select>
                        <button id="generate-plot-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Load Data
                        </button>
                    </div>
                </div>

                <div class="mt-4 border p-4 rounded-xl bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3 text-center text-gray-900">Raw Data Pool (Drag these numbers)</h3>
                    <div id="raw-data-container" class="min-h-[6rem] p-3 border-2 border-dashed border-gray-400 rounded-lg flex flex-wrap gap-2 justify-center content-start">
                        <!-- Draggable numbers populated by JS -->
                    </div>
                </div>

                <div class="mt-8 border p-4 rounded-xl bg-gray-50 flex flex-col lg:flex-row gap-6">
                    <!-- Plot Output -->
                    <div class="lg:w-1/3">
                        <h3 class="text-xl font-semibold mb-3 text-center text-gray-900">Stem-and-Leaf Plot</h3>
                        <div id="plot-output-dnd" class="plot-container rounded-xl shadow-xl">
                             <p class="text-center text-gray-500 p-4">Click "Load Data" to begin plotting.</p>
                        </div>
                        <p id="plot-key" class="key-line text-center"></p>
                    </div>

                    <!-- Stats Input for Self-Check -->
                    <div class="lg:w-2/3 border-t lg:border-t-0 lg:border-l border-gray-300 lg:pl-6 pt-4 lg:pt-0">
                        <h3 class="text-xl font-semibold mb-3 text-center text-gray-900">Calculate & Check Statistics</h3>
                        <div id="stats-output" class="space-y-3">
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="min-builder-input" class="w-24 font-medium">Minimum:</label><input type="number" id="min-builder-input" placeholder="Min" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="max-builder-input" class="w-24 font-medium">Maximum:</label><input type="number" id="max-builder-input" placeholder="Max" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="range-builder-input" class="w-24 font-medium">Range:</label><input type="number" id="range-builder-input" placeholder="Range" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="mode-builder-input" class="w-24 font-medium">Mode(s):</label><input type="text" id="mode-builder-input" placeholder="e.g., 62, 75" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="median-builder-input" class="w-24 font-medium">Median:</label><input type="number" step="0.01" id="median-builder-input" placeholder="Median" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                            <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="mean-builder-input" class="w-24 font-medium">Mean:</label><input type="number" step="0.01" id="mean-builder-input" placeholder="Mean" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                        </div>
                        <button id="check-builder-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md mt-4">
                            Check My Answers
                        </button>
                        <div id="builder-check-message" class="text-center font-medium"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button class="page-prev-btn flex items-center text-gray-700 hover:text-indigo-600 transition duration-150"><svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>← Previous Step</button>
                    <button class="page-next-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">Next Step →</button>
                </div>
            </section>
        </div>


        <!-- PAGE 2: INTERPRETATION PRACTICE (CHALLENGE CAROUSEL) -->
        <div id="page-2" class="page-content hidden">
            <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-3xl font-bold mb-4 text-blue-700" id="analysis-title">Step 3: Interpretation Challenge 1 of 4: Math Test Scores</h2>
                <p class="mb-4 text-gray-600">Analyze the plot below to calculate the key data landmarks. You must correctly answer all six stats to master the challenge and unlock the next one.</p>
                
                <div class="flex flex-col sm:flex-row gap-6 mb-6">
                    <!-- Analysis Plot -->
                    <div class="sm:w-1/2">
                        <h3 class="text-xl font-semibold mb-3 text-center text-gray-900">Data Plot</h3>
                        <div id="analysis-plot-output">
                            <!-- Plot generated dynamically by generateChallengePlot -->
                        </div>
                        <p id="analysis-key" class="key-line text-center"></p>
                    </div>

                    <!-- Input Fields -->
                    <div class="sm:w-1/2 space-y-3">
                        <h3 class="text-xl font-semibold mb-3 text-center text-gray-900">Enter Landmarks</h3>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="min-analysis-input" class="w-24 font-medium">Minimum:</label><input type="number" id="min-analysis-input" placeholder="Min" class="flex-1 p-1 border-gray-200 rounded text-right" readonly></div>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="max-analysis-input" class="w-24 font-medium">Maximum:</label><input type="number" id="max-analysis-input" placeholder="Max" class="flex-1 p-1 border-gray-200 rounded text-right" readonly></div>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="range-analysis-input" class="w-24 font-medium">Range:</label><input type="number" id="range-analysis-input" placeholder="Range" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="mode-analysis-input" class="w-24 font-medium">Mode(s):</label><input type="text" id="mode-analysis-input" placeholder="e.g., 62, 75" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="median-analysis-input" class="w-24 font-medium">Median:</label><input type="number" step="0.5" id="median-analysis-input" placeholder="Median" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                        <div class="flex items-center space-x-3 border-2 border-gray-300 rounded-lg p-2 bg-white transition duration-150"><label for="mean-analysis-input" class="w-24 font-medium">Mean:</label><input type="number" step="0.01" id="mean-analysis-input" placeholder="Mean" class="flex-1 p-1 border-gray-200 rounded text-right"></div>
                        
                        <button id="check-analysis-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                            Check My Answers
                        </button>
                        <button id="analysis-next-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md" disabled>
                            Next Challenge →
                        </button>
                        <button id="analysis-skip-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md mt-2 hidden" onclick="nextChallenge()">
                            Skip Challenge (Score 0/6 Recorded) →
                        </button>
                        <div id="analysis-check-message" class="text-center font-medium"></div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button class="page-prev-btn flex items-center text-gray-700 hover:text-indigo-600 transition duration-150"><svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>← Previous Step</button>
                    <!-- Next Step is hidden, managed by Next Challenge button -->
                    <button class="page-next-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hidden">Next Step →</button>
                </div>
            </section>
        </div>
        
        <!-- PAGE 3: FINAL REPORT -->
        <div id="page-3" class="page-content hidden">
            <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-green-500">
                <h2 class="text-3xl font-bold mb-4 text-green-700">Step 4: Mastery Report</h2>
                <p class="mb-6 text-gray-600">Review your overall performance on plot construction and statistical interpretation.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-700 font-medium">Plotting Mastery (Step 2)</p>
                        <h3 class="text-4xl font-extrabold text-blue-900 mt-2" id="builder-score-out">-- / 4</h3>
                        <p class="text-sm text-gray-600 mt-1">Data Sets Completed</p>
                    </div>
                     <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm text-green-700 font-medium">Interpretation Score (Step 3)</p>
                        <h3 class="text-4xl font-extrabold text-green-900 mt-2" id="analysis-score-out">-- / 24 (Max 6 pts)</h3>
                        <p class="text-sm text-gray-600 mt-1">Total Correct Statistics</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <p class="text-sm text-yellow-700 font-medium">Total Overall Score</p>
                        <h3 class="text-4xl font-extrabold text-yellow-900 mt-2" id="total-score-out">-- / 10</h3>
                        <p class="text-sm text-gray-600 mt-1">Total Points Earned</p>
                    </div>
                </div>
                
                <div id="final-message" class="text-center text-xl font-semibold mt-8 p-4 bg-gray-100 rounded-lg">
                    <!-- Final status message goes here -->
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button class="page-prev-btn flex items-center text-gray-700 hover:text-indigo-600 transition duration-150"><svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>← Previous Step</button>
                    <button class="page-next-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">Start Over</button>
                </div>
            </section>
        </div>
    </div>
</body>
</html>
